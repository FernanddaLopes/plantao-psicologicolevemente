
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plant√£o Psicol√≥gico Levemente ‚Äì Agendamentos</title>
  <style>
    :root{
      --brand:#00205B; /* Pantone 281 C */
      --accent:#AC8400; /* Pantone 118 C */
      --bg:#f7f7f9; --card:#fff; --line:#e5e7eb; --text:#101828; --muted:#667085;
    }
    *{box-sizing:border-box}
    html,body{margin:0;font-family: Bookerly, Georgia, 'Times New Roman', serif;background:var(--bg);color:var(--text)}
    header{background:var(--brand);color:#fff}
    header .wrap{max-width:1100px;margin:0 auto;padding:18px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.15);display:grid;place-items:center;font-weight:800}
    .brand h1{margin:0;font-size:20px}
    .brand small{opacity:.9}
    .btn{display:inline-block;background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.sec{background:#fff;color:#0b3d5c;border:1px solid var(--line)}
    .main{max-width:1100px;margin:16px auto;padding:0 14px;display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 6px rgba(16,24,40,.04)}
    .card .hd{padding:16px;border-bottom:1px solid var(--line);font-weight:800}
    .card .bd{padding:16px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .cols-3{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .choice{padding:16px;border:2px solid var(--line);border-radius:14px;background:#fff;text-align:center;font-weight:800;cursor:pointer}
    .choice:hover{border-color:var(--accent)}
    .choice.selected{border-color:var(--accent);box-shadow:0 0 0 3px rgba(172,132,0,.15)}
    .step{display:none}
    .step.active{display:block}
    .slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
    .slot{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;text-align:center;cursor:pointer}
    .slot.full{opacity:.35;cursor:not-allowed}
    .slot.selected{outline:3px solid var(--accent)}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#fff;color:var(--brand);font-weight:800;border:1px dashed var(--brand)}
    .helper{color:var(--muted);font-size:14px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
    .kpi{padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .kpi b{font-size:22px}
    footer{margin:24px 0;text-align:center;color:var(--muted)}
    @media(max-width:900px){.main{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">Leve</div>
        <div>
          <h1>Plant√£o Psicol√≥gico Levemente</h1>
          <small>Agendamentos Online e Presenciais</small>
        </div>
      </div>
      <div>
        <a class="btn sec" href="#sobre">Como funciona</a>
        <button class="btn" onclick="document.getElementById('wizardCard').scrollIntoView({behavior:'smooth'})">Agendar agora</button>
      </div>
    </div>
  </header>

  <main class="main">
    <section class="card" style="grid-column:1/-1">
      <div class="bd">
        <span class="badge">S√©rie autom√°tica ‚Ä¢ 6 sess√µes</span>
        <h2 style="margin:.4rem 0 .6rem">Seja bem-vindo ao agendamento do <b>Plant√£o Psicol√≥gico Levemente</b>! Este √© um espa√ßo de cuidado e acolhimento.</h2>
        <p class="helper">Ao confirmar a primeira sess√£o, reservamos automaticamente as pr√≥ximas <b>5 semanas</b> no mesmo dia e hor√°rio. Voc√™ recebe lembretes antes de cada encontro.</p>
      </div>
    </section>

    <section id="wizardCard" class="card" aria-labelledby="Agendamento">
      <div class="hd">Agendamento</div>
      <div class="bd">
        <div id="step1" class="step active">
          <p class="helper">Escolha a modalidade. Voc√™ confirma a s√©rie de <b>6 sess√µes</b> em sequ√™ncia.</p>
          <div class="choices">
            <div class="choice" data-mod="online">üßë‚Äçüíª Atendimento <b>Online</b></div>
            <div class="choice" data-mod="presencial">üè• Atendimento <b>Presencial</b></div>
          </div>
          <div style="margin-top:10px"><button class="btn sec" id="whatsBtn">Prefiro falar pelo WhatsApp</button></div>
        </div>

        <div id="step2" class="step">
          <div class="grid cols-2">
            <div>
              <label for="unidade">Unidade (para presencial)</label>
              <select id="unidade"></select>
              <small class="helper">Se sua unidade n√£o estiver na lista, escolha <b>Online</b>.</small>
            </div>
            <div>
              <label for="turno">Prefer√™ncia de turno</label>
              <select id="turno">
                <option value="qualquer">Qualquer</option>
                <option value="manha">Manh√£</option>
                <option value="tarde">Tarde</option>
                <option value="noite">Noite</option>
              </select>
            </div>
          </div>
          <div style="margin-top:14px">
            <button class="btn sec" id="back1">Voltar</button>
            <button class="btn" id="next2">Pr√≥ximo</button>
          </div>
        </div>

        <div id="step3" class="step">
          <h3>Escolha o dia e hor√°rio do <span class="badge">1¬∫ atendimento</span></h3>
          <p class="helper">Reservaremos as <b>5 semanas seguintes</b> no mesmo dia e hor√°rio. Se cair em feriado/domingo, ajustamos automaticamente.</p>
          <div id="slots" class="slots" aria-live="polite"></div>
          <div style="margin-top:14px">
            <button class="btn sec" id="back2">Voltar</button>
            <button class="btn" id="next3" disabled>Pr√≥ximo</button>
          </div>
        </div>

        <div id="step4" class="step">
          <h3>Revise sua s√©rie de 6 sess√µes</h3>
          <ul id="serieList"></ul>
          <details><summary>Regras</summary>
            <p class="helper">Remarca√ß√£o at√© <b>24h</b> antes. <b>2 faltas</b> seguidas pausam a s√©rie para reavalia√ß√£o.</p>
          </details>
          <div style="margin-top:14px">
            <button class="btn sec" id="back3">Voltar</button>
            <button class="btn" id="next4">Avan√ßar</button>
          </div>
        </div>

        <div id="step5" class="step">
          <h3>Seus dados e consentimento</h3>
          <div class="grid cols-3">
            <div><label for="nome">Nome</label><input id="nome" placeholder="Seu nome" /></div>
            <div><label for="telefone">WhatsApp</label><input id="telefone" placeholder="DDD + n√∫mero" /></div>
            <div><label for="email">E-mail</label><input id="email" placeholder="voce@exemplo.com" /></div>
          </div>
          <label style="display:flex; gap:8px; margin-top:10px"><input id="consent" type="checkbox" style="width:auto"> Concordo com o uso dos meus dados para <b>agendamento, lembretes e pesquisa</b>.</label>
          <div style="margin-top:14px">
            <button class="btn sec" id="back4">Voltar</button>
            <button class="btn" id="confirmar" disabled>Confirmar agendamento</button>
          </div>
        </div>

        <div id="step6" class="step">
          <h3>Pronto! S√©rie confirmada ‚úÖ</h3>
          <p>Voc√™ receber√° lembretes <b>D‚Äë1</b> (e opcionais 2h antes). Utilize:</p>
          <div class="grid cols-3">
            <button class="btn" id="baixarICS">Baixar calend√°rio (.ics)</button>
            <button class="btn sec" id="exportarCSV">Exportar sess√µes (CSV)</button>
            <button class="btn sec" id="simularLembrete">Simular lembrete D‚Äë1</button>
          </div>
        </div>
      </div>
    </section>

    <section id="psicologo" class="card">
      <div class="hd">Portal do Psic√≥logo</div>
      <div class="bd">
        <p class="helper">Veja sua agenda e (opcional) inclua o <b>link da sess√£o online</b> (Google Meet/Teams/Zoom). O link aparecer√° para o colaborador na confirma√ß√£o e no arquivo .ICS.</p>
        <table id="agendaPsi" style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left;border-bottom:1px solid var(--line);padding:8px">Data</th><th style="text-align:left;border-bottom:1px solid var(--line);padding:8px">Hora</th><th style="text-align:left;border-bottom:1px solid var(--line);padding:8px">Modo</th><th style="text-align:left;border-bottom:1px solid var(--line);padding:8px">Unidade</th><th style="text-align:left;border-bottom:1px solid var(--line);padding:8px">Link da sess√£o</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="gestor" class="card">
      <div class="hd">Painel da Gest√£o</div>
      <div class="bd">
        <div class="kpis" id="kpis"></div>
        <div style="margin-top:8px">
          <button class="btn sec" id="exportarTudo">Exportar dados (JSON)</button>
          <button class="btn sec" id="limpar">Limpar dados de teste</button>
        </div>
      </div>
    </section>

    <section id="sobre" class="card" style="grid-column:1/-1">
      <div class="hd">Como funciona</div>
      <div class="bd">
        <ol>
          <li>Escolha <b>Online</b> ou <b>Presencial</b> (presencial nas unidades listadas).</li>
          <li>Selecione o 1¬∫ hor√°rio; reservamos automaticamente +5 semanas.</li>
          <li>Lembretes antes de cada sess√£o e <b>NPS</b> ao final da 6¬™.</li>
        </ol>
        <small class="helper">Dados armazenados apenas no seu navegador para fins de demonstra√ß√£o.</small>
      </div>
    </section>
  </main>

  <footer>¬© Levemente ‚Äì Plant√£o Psicol√≥gico (Piloto)</footer>

  <script>
    // ====== CONFIG LOAD ======
    const CONFIG = { unidades: [], locais: {}, corPrim:'#00205B', corAcc:'#AC8400', dur:50 };
    fetch('config.json').then(r=>r.json()).then(cfg=>{
      CONFIG.corPrim = cfg.marca.cores.primaria_hex || CONFIG.corPrim;
      CONFIG.corAcc = cfg.marca.cores.destaque_hex || CONFIG.corAcc;
      CONFIG.dur = cfg.duracao_minutos || 50;
      document.documentElement.style.setProperty('--brand', CONFIG.corPrim);
      document.documentElement.style.setProperty('--accent', CONFIG.corAcc);

      // Unidades e locais
      CONFIG.unidades = (cfg.unidades_presenciais||[]).map(u=>u.nome);
      CONFIG.locais = Object.fromEntries((cfg.unidades_presenciais||[]).map(u=>[u.nome, u.local]));

      document.getElementById('unidade').innerHTML = '<option value="">Selecione</option>' + CONFIG.unidades.map(u=>`<option>${u}</option>`).join('');
      document.getElementById('sobre').querySelector('.bd').insertAdjacentHTML('beforeend', `<p class="helper">Presencial dispon√≠vel em: <b>${CONFIG.unidades.join(', ')}</b>.</p>`);
    });

    // ====== STATE & STORAGE ======
    const SKEY = 'leve_pp_v3';
    const getAll = ()=> JSON.parse(localStorage.getItem(SKEY)||'[]');
    const setAll = arr => localStorage.setItem(SKEY, JSON.stringify(arr));

    const state = { mod:null, unidade:null, slot:null, serie:[], pessoa:{nome:'',telefone:'',email:'',consent:false} };

    // ====== WIZARD ======
    function show(n){ document.querySelectorAll('#wizardCard .step').forEach((el,i)=> el.classList.toggle('active', i===n-1)); }
    document.querySelectorAll('.choice').forEach(ch=> ch.addEventListener('click', ()=>{ document.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected')); ch.classList.add('selected'); state.mod = ch.dataset.mod; show(state.mod==='presencial'?2:3); }));
    document.getElementById('whatsBtn').onclick = ()=> window.open('https://wa.me/5599999999999?text='+encodeURIComponent('Ol√°! Quero agendar o Plant√£o Psicol√≥gico Levemente.'),'_blank');

    document.getElementById('back1').onclick = ()=> show(1);
    document.getElementById('next2').onclick = ()=>{ state.unidade = document.getElementById('unidade').value || null; show(3); };
    document.getElementById('back2').onclick = ()=> state.mod==='presencial'?show(2):show(1);

    const btnNext3 = document.getElementById('next3');
    function renderSlots(){
      const div = document.getElementById('slots'); div.innerHTML='';
      const now = new Date();
      const times = ['08:00','10:00','14:00','16:00','19:00'];
      for(let i=0;i<14;i++){
        const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()+i);
        const iso = d.toISOString().slice(0,10);
        for(const t of times){
          const provider = state.mod==='online' ? (Math.random()<.7?'A':'B') : 'B';
          const full = Math.random()<.1;
          const b = document.createElement('button');
          b.className='slot'+(full?' full':''); b.textContent = `${d.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit'})} ‚Ä¢ ${t}h ‚Ä¢ Prov. ${provider}`;
          b.onclick = ()=>{ if(full) return; document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected')); b.classList.add('selected'); state.slot = {dateISO:iso,time:t,provider}; btnNext3.disabled=false; };
          div.appendChild(b);
        }
      }
    }
    renderSlots();

    btnNext3.onclick = ()=>{ buildSerie(); renderSerie(); show(4); };
    document.getElementById('back3').onclick = ()=> show(3);
    document.getElementById('next4').onclick = ()=> show(5);

    // Step 5
    ['nome','telefone','email'].forEach(id=> document.getElementById(id).addEventListener('input', canConfirm));
    document.getElementById('consent').addEventListener('change', canConfirm);
    function canConfirm(){
      state.pessoa.nome = nome.value.trim(); state.pessoa.telefone = telefone.value.trim(); state.pessoa.email = email.value.trim(); state.pessoa.consent = consent.checked;
      document.getElementById('confirmar').disabled = !(state.pessoa.nome && state.pessoa.telefone && state.pessoa.consent);
    }

    document.getElementById('confirmar').onclick = ()=>{
      const all = getAll(); const nomeP = state.pessoa.nome;
      state.serie.forEach(s=> all.push({...s, nome:nomeP}));
      setAll(all); updateKPIs(); renderAgendaPsi(); show(6);
    };

    // S√©rie 6x
    function buildSerie(){
      const serie = []; const first = new Date(state.slot.dateISO+'T00:00:00');
      for(let k=0;k<6;k++){
        const d = new Date(first); d.setDate(d.getDate()+7*k); if(d.getDay()===0) d.setDate(d.getDate()+1);
        const iso = d.toISOString().slice(0,10);
        const unidade = state.mod==='presencial' ? (state.unidade||'') : '';
        const provider = state.mod==='online' ? (Math.random()<.7?'A':'B') : 'B';
        serie.push({dateISO:iso,time:state.slot.time,provider,modo:state.mod,unidade,link:''});
      }
      state.serie = serie;
    }

    function renderSerie(){ const ul = document.getElementById('serieList'); ul.innerHTML='';
      state.serie.forEach((s,i)=>{ const d=new Date(s.dateISO+'T00:00:00'); const loc = s.unidade? (' ‚Ä¢ '+s.unidade+' ('+(CONFIG.locais[s.unidade]||'local a confirmar')+')') : ''; ul.insertAdjacentHTML('beforeend', `<li><b>${i+1}/6</b> ‚Äì ${d.toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'2-digit'})} √†s <b>${s.time}h</b> ‚Ä¢ Prov. <b>${s.provider}</b>${loc}</li>`); }); }

    // ====== Portal Psic√≥logo ======
    function renderAgendaPsi(){
      const tbody = document.querySelector('#agendaPsi tbody'); tbody.innerHTML='';
      const itens = getAll().sort((a,b)=> (a.dateISO+a.time).localeCompare(b.dateISO+b.time));
      for(const it of itens){ const tr=document.createElement('tr');
        tr.innerHTML = `<td style='padding:8px;border-bottom:1px solid var(--line)'>${fmt(it.dateISO)}</td>`+
                       `<td style='padding:8px;border-bottom:1px solid var(--line)'>${it.time}h</td>`+
                       `<td style='padding:8px;border-bottom:1px solid var(--line)'>${it.modo}</td>`+
                       `<td style='padding:8px;border-bottom:1px solid var(--line)'>${it.unidade||'-'}</td>`+
                       `<td style='padding:8px;border-bottom:1px solid var(--line)'><input style='width:100%;padding:8px' placeholder='https://meet.google.com/...' value='${it.link||''}'></td>`+
                       `<td style='padding:8px;border-bottom:1px solid var(--line)'><button class='btn sec'>Salvar</button></td>`;
        const input = tr.querySelector('input'); const btn = tr.querySelector('button');
        btn.onclick = ()=>{ const all=getAll(); const idx=all.findIndex(s=> s.nome===it.nome && s.dateISO===it.dateISO && s.time===it.time); if(idx>-1){ all[idx].link = input.value.trim(); setAll(all); alert('Link salvo. Ser√° inclu√≠do na confirma√ß√£o e no .ICS.'); }}
        tbody.appendChild(tr);
      }
    }

    function fmt(iso){ const d=new Date(iso+'T00:00:00'); return d.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit'}); }

    // ====== Gest√£o ======
    function updateKPIs(){ const k=document.getElementById('kpis'); const all=getAll(); const total=all.length; const pres=all.filter(s=>s.presenca==='Presente').length; const falt=all.filter(s=>s.presenca==='Falta').length; const pend=total-pres-falt; const comp= total? Math.round(pres/total*100):0; const ns= total? Math.round(falt/total*100):0; k.innerHTML=`<div class='kpi'><div>Total de sess√µes</div><b>${total}</b></div><div class='kpi'><div>Comparecimento</div><b>${comp}%</b><small class='muted'>${pres} de ${total}</small></div><div class='kpi'><div>No‚Äëshow</div><b>${ns}%</b><small class='muted'>${falt} de ${total}</small></div><div class='kpi'><div>Agendadas futuras</div><b>${pend}</b></div>`; }
    updateKPIs(); renderAgendaPsi();

    document.getElementById('exportarTudo').onclick = ()=>{ const blob = new Blob([JSON.stringify({sessoes:getAll()},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dados_plantao.json'; a.click(); };
    document.getElementById('limpar').onclick = ()=>{ if(confirm('Apagar todos os dados de teste?')){ localStorage.removeItem(SKEY); updateKPIs(); renderAgendaPsi(); } };

    // ====== Exports ======
    document.getElementById('baixarICS').onclick = ()=>{ const nome = state.pessoa.nome || 'Participante'; const serie = getAll().filter(s=> s.nome===nome); const ics = buildICS(nome, serie, CONFIG.dur); const blob=new Blob([ics],{type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='serie6_levantemente.ics'; a.click(); };
    document.getElementById('exportarCSV').onclick = ()=>{ const nome= state.pessoa.nome || 'Participante'; const serie = getAll().filter(s=> s.nome===nome); const rows=[["Nome","Data","Hora","Modo","Unidade","Link"]]; serie.forEach(s=> rows.push([nome, s.dateISO, s.time, s.modo, s.unidade||'', s.link||''])); const csv = rows.map(r=> r.map(x=>`"${String(x).replace('"','\"')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='agendamentos_serie6.csv'; a.click(); };
    document.getElementById('simularLembrete').onclick = ()=> alert('Lembrete (D‚Äë1): sua sess√£o √© amanh√£ √†s '+(state.slot?state.slot.time:'--')+'h. 1) Confirmar  2) Remarcar  3) Cancelar');

    function toICS(d){ const pad=n=>n<10?'0'+n:n; return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+'00Z'; }
    function esc(s){ return String(s).replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }
    function buildICS(nome, serie, dur){ const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Levemente//Plantao//PT-BR']; for(const s of serie){ const dt=new Date(s.dateISO+'T'+s.time+':00'); const dtS=toICS(dt); const dtE=toICS(new Date(dt.getTime()+dur*60000)); const uid=`${s.dateISO}-${s.time}-${Math.random().toString(36).slice(2)}@levemente`; const loc = s.modo==='presencial' ? (s.unidade+(CONFIG.locais[s.unidade]?' - '+CONFIG.locais[s.unidade]:' (local a confirmar)')) : 'Online'; const desc = 'Sess√£o '+s.modo+(s.link? ' ‚Äì Link: '+s.link : ''); lines.push('BEGIN:VEVENT','UID:'+uid,'DTSTAMP:'+toICS(new Date()),'DTSTART:'+dtS,'DTEND:'+dtE,'SUMMARY:Plant√£o Psicol√≥gico Levemente','DESCRIPTION:'+esc(desc),'LOCATION:'+esc(loc),'END:VEVENT'); } lines.push('END:VCALENDAR'); return lines.join('\r\n'); }
  </script>
</body>
</html>
